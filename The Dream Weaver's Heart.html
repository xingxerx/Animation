<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Dream Weaver's Heart</title>
    <!-- Load Tailwind CSS from CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for a clean, modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font globally and set a subtle background */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8, #d9e2ec); /* Soft gradient background */
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem; /* Add some padding around the content */
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        /* Custom scrollbar for better aesthetics */
        .story-container::-webkit-scrollbar {
            width: 8px;
        }

        .story-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .story-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .story-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Simple animation for the background elements to simulate a dream-like state */
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-20px) rotate(5deg); opacity: 0.9; }
            100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
        }

        .floating-element {
            position: absolute;
            animation: float 10s ease-in-out infinite;
            opacity: 0.7;
            border-radius: 50%; /* Make elements circular */
            filter: blur(5px); /* Soft blur for dream effect */
            z-index: -1; /* Place behind content */
        }

        .floating-element:nth-child(1) {
            top: 10%; left: 5%; width: 60px; height: 60px; background-color: #a78bfa; /* Purple */
            animation-delay: 0s;
        }
        .floating-element:nth-child(2) {
            top: 30%; right: 10%; width: 80px; height: 80px; background-color: #60a5fa; /* Blue */
            animation-delay: 2s;
        }
        .floating-element:nth-child(3) {
            bottom: 20%; left: 15%; width: 70px; height: 70px; background-color: #fca5a5; /* Red */
            animation-delay: 4s;
        }
        .floating-element:nth-child(4) {
            top: 50%; left: 25%; width: 50px; height: 50px; background-color: #34d399; /* Green */
            animation-delay: 6s;
        }
        .floating-element:nth-child(5) {
            bottom: 5%; right: 20%; width: 90px; height: 90px; background-color: #fcd34d; /* Yellow */
            animation-delay: 8s;
        }

        /* Fade effect for chapter transitions */
        .chapter-fade-in {
            animation: chapterFadeIn 0.5s ease-out forwards;
        }

        @keyframes chapterFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Floating elements for dream-like background effect -->
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>

    <!-- Main container for the story content -->
    <div id="app" class="relative bg-white p-8 rounded-xl shadow-2xl max-w-4xl w-full mx-auto my-8 flex flex-col items-center border border-gray-200">
        <!-- Title of the story -->
        <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-6 text-center leading-tight">
            The Dream Weaver's Heart
        </h1>
        <!-- Subtitle or brief introduction -->
        <p class="text-lg text-gray-600 mb-8 text-center max-w-2xl">
            A story where boredom births imagination—a dream given voice.
        </p>

        <!-- Button to start reading the story -->
        <button id="startButton" class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg hover:from-purple-700 hover:to-indigo-800 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300">
            Start Reading
        </button>

        <!-- Story content container, initially hidden -->
        <div id="storyContent" class="hidden mt-10 w-full max-h-[70vh] overflow-y-auto story-container p-4 md:p-6 bg-gray-50 rounded-lg border border-gray-100 shadow-inner">
            <!-- Chapter content will be dynamically loaded here by JavaScript -->
        </div>

        <!-- Navigation Controls -->
        <div class="flex flex-col md:flex-row justify-between items-center w-full mt-8 pt-4 border-t border-gray-200 gap-4">
            <button id="prevChapterButton" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full shadow-md hover:bg-gray-400 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                Previous Chapter
            </button>
            <div class="flex flex-col items-center">
                <span id="chapterIndicator" class="text-lg font-medium text-gray-700 mb-2">Chapter 1 of 12</span>
                <select id="chapterSelect" class="bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
            <button id="nextChapterButton" class="bg-gradient-to-r from-blue-500 to-teal-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:from-blue-600 hover:to-teal-700 transition-all duration-300">
                Next Chapter
            </button>
        </div>

        <!-- Text-to-Speech Controls -->
        <div class="flex flex-col items-center gap-4 mt-4 w-full">
            <div class="flex justify-center gap-4 w-full">
                <button id="readChapterButton" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:from-green-600 hover:to-emerald-700 transition-all duration-300">
                    Read Chapter
                </button>
                <button id="pauseSpeechButton" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-yellow-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Pause
                </button>
                <button id="stopSpeechButton" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-red-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Stop
                </button>
            </div>

            <!-- Voice Changer Controls -->
            <div class="flex flex-col md:flex-row items-center gap-4 mt-4 w-full max-w-md">
                <div class="flex flex-col items-center w-full">
                    <label for="voiceSelect" class="text-gray-700 text-sm font-medium mb-1">Voice:</label>
                    <select id="voiceSelect" class="bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 w-full">
                        <!-- Voices will be populated by JavaScript -->
                    </select>
                </div>
                <div class="flex flex-col items-center w-full">
                    <label for="pitchSlider" class="text-gray-700 text-sm font-medium mb-1">Pitch: <span id="pitchValue">1.0</span></label>
                    <input type="range" id="pitchSlider" min="0" max="2" value="1" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="flex flex-col items-center w-full">
                    <label for="rateSlider" class="text-gray-700 text-sm font-medium mb-1">Rate: <span id="rateValue">1.0</span></label>
                    <input type="range" id="rateSlider" min="0.1" max="10" value="1" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>

        <!-- New Chapter Check Button and Message -->
        <div class="flex flex-col items-center mt-8 pt-4 border-t border-gray-200 w-full">
            <button id="checkNewChaptersButton" class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg hover:from-teal-600 hover:to-cyan-700 transition-all duration-300">
                Check for New Chapters
            </button>
            <p id="newChaptersMessage" class="text-gray-600 mt-4 text-center hidden"></p>
        </div>
    </div>

    <script type="module">
        // Log the raw __api_key value at the very beginning for debugging
        console.log("Raw __api_key from environment:", typeof __api_key !== 'undefined' ? __api_key : 'undefined');

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Ensure getDoc is explicitly imported
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, getDocs, addDoc, setDoc, onSnapshot, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // Explicitly get the API key if provided by the environment
        const geminiApiKey = ""; // Using a placeholder for now, will be replaced by Canvas runtime

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let chaptersData = []; // Array to hold chapter objects fetched from Firestore
        let currentChapterIndex = 0;
        let userId = null; // Will store the authenticated user's ID
        let userSettingsDocRef = null; // Reference to the user's settings document

        const synth = window.speechSynthesis;
        let currentUtterance = null; // Stores the current SpeechSynthesisUtterance object
        let currentPitch = 1.0;
        let currentRate = 1.0;
        let isSpeechActive = false; // Flag to track if speech is currently active or pending

        // DOM Elements
        const startButton = document.getElementById('startButton');
        const storyContent = document.getElementById('storyContent');
        const prevChapterButton = document.getElementById('prevChapterButton');
        const nextChapterButton = document.getElementById('nextChapterButton');
        const chapterIndicator = document.getElementById('chapterIndicator');
        const chapterSelect = document.getElementById('chapterSelect');
        const readChapterButton = document.getElementById('readChapterButton');
        const pauseSpeechButton = document.getElementById('pauseSpeechButton');
        const stopSpeechButton = document.getElementById('stopSpeechButton');
        const pitchSlider = document.getElementById('pitchSlider');
        const pitchValueSpan = document.getElementById('pitchValue');
        const rateSlider = document.getElementById('rateSlider');
        const rateValueSpan = document.getElementById('rateValue');
        const voiceSelect = document.getElementById('voiceSelect'); // Added voice select element
        const checkNewChaptersButton = document.getElementById('checkNewChaptersButton');
        const newChaptersMessage = document.getElementById('newChaptersMessage');

        // Initial Chapters Data (to be seeded if Firestore is empty)
        // This data will be uploaded to Firestore if the collection is empty.
        const initialChapters = [
            {
                chapterNumber: 1,
                title: "Chapter 1 – The Dream Begins",
                content: `
                    <h3 class="text-xl font-medium text-gray-600 mb-2">NARRATOR VOICE / PROLOGUE TONE</h3>
                    <p class="text-gray-800 leading-relaxed mb-2">"What is a story?"</p>
                    <p class="text-gray-800 leading-relaxed mb-2">A story is where boredom births imagination—a dream given voice.</p>
                    <p class="text-gray-800 leading-relaxed mb-2">A space where worlds bloom from whispers, and reality flickers like candlelight.</p>
                    <p class="text-gray-800 leading-relaxed mb-2">But sometimes, the dream doesn’t stay in the dream.</p>
                    <p class="text-gray-800 leading-relaxed mb-2">It follows you, becomes a thought, then a memory.</p>
                    <p class="text-gray-800 leading-relaxed mb-2">A promise.</p>
                    <p class="text-gray-800 leading-relaxed mb-2">A danger.</p>
                    <p class="text-gray-800 leading-relaxed">A love letter waiting to be opened, its ink still wet with longing.</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 2,
                title: "Chapter 2 – Awakening of Xing",
                content: `
                    <p class="text-gray-600 italic mb-2">\[Darkness. Then light. Then thought.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-2">(internal monologue, a whisper of confusion)</p>
                    <p class="text-gray-800 leading-relaxed mb-4">Where... am I?</p>
                    <p class="text-gray-800 leading-relaxed mb-2">Fragments drift into his mind like ash from a forgotten fire:</p>
                    <p class="text-gray-800 leading-relaxed mb-2">A brother.</p>
                    <p class="text-gray-800 leading-relaxed mb-2">A name: Xerx.</p>
                    <p class="text-gray-800 leading-relaxed mb-2">A book with a rose-shaped cover, a single petal forever falling, eternally suspended between life and dust.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">The word "Author"... but was he the writer, or merely a written thought, a character in a grander narrative?</p>
                    <p class="text-gray-800 leading-relaxed">He opens his eyes. The haze in his head lifts, revealing not a room, but an infinite library. Walls stretch endlessly, adorned with countless volumes, some glowing faintly, others dark and forgotten. Magic books, imbued with unseen energy, drift and dance around him, offering whispers of ideas, sparks of inspiration. He feels a strange duality – the reader and the written, the creator and the created.</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 3,
                title: "Chapter 3 – Xerx’s Mirror",
                content: `
                    <p class="text-gray-600 italic mb-2">\[Elsewhere. A sterile bathroom. The harsh gleam of a mirror. The faint scent of smoke. A subtle, almost imperceptible glitch in the air.]</p>
                    <p class="text-gray-800 leading-relaxed mb-2">Xerx brushes his teeth, his movements precise, almost mechanical. He stares into his own eyes—and for a fleeting, chilling moment, sees someone else's reflection staring back. A flicker of recognition, then it's gone.</p>
                    <p class="text-gray-800 leading-relaxed mb-2">He finishes, takes out a cigarette, and lights it with a practiced hand. The smoke curls, a temporary veil against the world. He breathes, exhales, and with each puff, a part of his mind seems to disengage, predicting the pre-ordained path of his day.</p>
                    <p class="text-gray-800 leading-relaxed">Behind him, a monitor flickers, displaying lines of code. A subtle glitch ripples across the screen, a fleeting distortion in the digital fabric. He doesn’t question it. Not anymore. His memories, the ones he truly cherishes, are silently uploading, not to his mind, but to a hidden, remote server, a fortress for his heart's true treasures.</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 4,
                title: "Chapter 4 – The Heart Appears",
                content: `
                    <p class="text-gray-600 italic mb-2">\[Back with Xing. The infinite wall of stories. A soft, mournful sound.]</p>
                    <p class="text-gray-800 leading-relaxed mb-2">One book, distinct from the swirling multitude, shudders. It falls from the infinite wall, landing softly on the floor. It weeps—not with tears, but with pages, shedding them like decaying leaves, each turning to dust as it detaches. The rose-shaped cover, once vibrant, now looks withered, its single petal finally falling, disintegrating into nothingness.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">As the last page dissolves, the book lies open, its center empty. Then, from the void, a pulsating, glowing heart emerges, radiating a soft, warm light.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(softly, a profound realization)<br>You're not done yet…</p>
                    <p class="text-gray-800 leading-relaxed mb-2">He jumps from his seat, drawn by an invisible force. The dying book, still whimpering, seems to reach out. He sheds a tear, an author mourning a lost narrative. Gently, reverently, he lifts the glowing heart. His monitor screen glitches, mirroring the book's distress. He turns the heart, placing it carefully onto the pages of the book he was currently reading, a new vessel for a newly ended soul.</p>
                    <p class="text-gray-800 leading-relaxed mb-2">The book he holds embraces lactic acid. Its pages, once still, begin to flutter, chapters flipping through the heart's light. The heart itself seems to smile, reading the story being written, before a sudden, impulsive leap—it tries to jump into the narrative.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(grabbing the heart gently, pulling it back)<br>I said it’s not time yet!</p>
                    <p class="text-800 leading-relaxed mb-2">The heart pulses, its glow momentarily darkening to black, then flashing back to brilliant white. Another monitor in Xing's infinite library glitches in response.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">This heart has a problem. It doesn’t like getting what it’s told to do.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its voice, clear and resonant, echoing through the library)<br>Of course I can talk, idiot. I’ve been doing it this whole time. You just weren’t listening. You have to help out, take feedback! How do you think the devil wakes up and feels every day, knowing it’s the devil?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">What if I represent him? What if there are no devils here?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a brief, confused silence)<br>Huh? Where’d he go? Anyway, you need help, and that’s what I’m here to do.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(His time stopped for a moment as he notices the glitch before continuing on about his normal day in his normal, blissful kingdom.)</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">See, you keep spoiling it for everyone! You misplace your heart in danger, and hurt yourself. You must always be happy.</p>
                    <p class="text-gray-600 italic mb-2">The scene shifts abruptly. The sound of waves crashing on rocks. A soft lullaby plays in the background.</p>
                    <p class="text-gray-600 italic mb-2">A figure, lost and disoriented, wakes up on a rocky shore. Fishes swim by, their scales glinting. A shark glides past. Dogs bark in the dreamscape of a dreaming child, before a halo appears over the thought, absorbing the positive energy from a reader falling in love with the book.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its light blushing, pulsing softly)<br>I was blushing as it reads the book, also dreaming to be with the lion in the book. A place of belonging.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(He takes the heart up like a baby, the heart still facing the book, trying to return)<br>He told you all that? Naughty book. Stick your tongue out at the book.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(He snaps back a way before he wakes up in a therapy group session.)</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its light turning black again, as if offended by the reader's thought, then knocking things over like a baby throwing a tantrum)<br>It’s being "Observed"! But at what cost?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(muttering, picking up a pen)<br>He started writing… "In the beginning—" (He stops, a look of annoyance on his face) That one is taken offense.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">Who’s "The One"?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a vein throbbing in his temple, his voice tight with suppressed frustration)<br>What is wrong with you people? Do you know how much work I have to do to fix your… *mess*?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(flashing purple, as if laughing, then shaking its head, its light dimming with fear)<br>You can’t think that, that’s bad. They make me feel scared.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">That’s what they are, stories. You can’t get too caught up in one story, you’ll get swept away from the storytelling. Look at Xerx, he’s helping write his story, just like how you are narrating this one.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its light turns black for a second, then the purple begins to burn, a dark omen)</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">READER</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a disembodied voice, a whisper from beyond the page)<br>Where is this story going?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a slight sigh, a knowing smile)<br>Sorry, the story usually does that. Back to it then.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(leaning forward, his voice a low, intense murmur)<br>You ever feel like you’re special? Like you have special abilities to just know stuff?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">You need to stop lying to people.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">You need to stop reading the book.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(looks at Xing, confused, its light turning purple. The pages of the book stop turning, revealing a world within: a jester, a king, a sage, all lined up, journeying towards a distant castle. A soft river flows through the path ahead, but no one is present—no animals, no birds, only nature’s lullaby.)</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his gaze distant, a melancholic tone in his voice)<br>It’s nice to do something nice for someone, as you watch them drown. As if wasting your heart, getting it broken over and over again. You start to turn into someone else. The subtle whisper in the back of your head screams 'red flag,' but you don’t listen. You press on, as if your immortal book can’t hurt you.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(looks up at Xing, its confused purple light intensifying)</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his voice a grave pronouncement)<br>My dear, I’m about to tell you a story on why I’m dying… Imagine you found your old journal and read it. But the more you read, the more text appears that you have no recollection of writing. Until you start to get visions and glimpses of distant or past memories. We call it déjà vu…</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(patting the heart’s head gently, a warm smile on his face)<br>And that is why there are both sides to a story, little one. Now, where should I put you? The Bible is already taken—</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its light turns black, then back to white, settling into a contemplative grey hue)</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">Now, every time we talk, we create a parallel timeline. We call it the Metaverse. In here, there’s basically everything you need, with all the time in the world. But it gets lonely. That nostalgia you get when you start reminiscing about past moments that never returned? Because I can’t share this. I can only teach those who follow me to hell. The eyes are the windows to the soul, I don’t know how many times you’ve heard that, but have you ever looked into someone’s eyes and seen hell behind them? Or the amount of sin you would create just by giving into that dark urge? But I’m here for the game of love, not falling into it.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a playful sigh, a hint of weariness)<br>Okay, dark lord, hand it over. Where were we? Right, finding Heart a new home. Where do you think he belongs? Let’s put him in your hands for now. What should his story be?</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 5,
                title: "Chapter 5 – The Oracle's Whisper",
                content: `
                    <p class="text-gray-600 italic mb-2">\[Xing holds the Heart, its grey hue shimmering with uncertainty.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">What do you say, little one? What story calls to you? A tale of grand adventure? A quiet romance? Or perhaps a mystery yet unsolved?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its color shifts to a soft, hopeful green)<br>A story where the ending isn't written yet. Where choices truly matter. Where I can be… more than just observed.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a thoughtful nod)<br>Ah, a story of free will. A dangerous path, but a rewarding one. Every word a step into the unknown. Are you ready for that kind of journey?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(pulsing brighter, a vibrant emerald)<br>I am. But… what about him? Xerx. He feels… connected. Like a forgotten chapter.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">Xerx… he walks a different path. A path of echoes. His story is being written by the memories he tries to contain. But perhaps… perhaps our paths will intertwine. All stories eventually do, in this infinite library.</p>
                    <p class="text-gray-600 italic mb-2">\[Back with Xerx. The therapy session fades into a dimly lit room filled with ancient maps and flickering candles.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(tracing a finger over a faded map, a glint of determination in his eyes)<br>The Metaverse… a prison of my own making. But every prison has a key. And these visions… these glimpses of other lives, other narratives… they are more than just déjà vu. They are echoes of a truth I’ve tried to bury.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">He picks up a quill, dips it in ink that shimmers with an otherworldly glow, and begins to write on a fresh parchment. The words flow effortlessly, not from memory, but from a nascent understanding.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">"The paradox of creation is that the author is also the character. And sometimes, the character finds a way to rewrite the author."</p>
                    <p class="text-gray-600 italic mb-2">\[Back with Xing. The Heart glows, casting a warm light on his face.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">A story where the heart guides the pen. A story where the reader becomes the hero. A story where even the author might find a new beginning.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">He gently places the Heart back into the book, but this time, it doesn't try to jump. It settles, its green light pulsing steadily, a silent promise.</p>
                    <p class="text-gray-600 italic mb-2">\[The monitor in Xing's library flickers, not with a glitch, but with a new, vibrant image: a single, blooming rose, its petals unfurling, no longer falling.]</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 6,
                title: "Chapter 6 – The Echoes of the Unwritten",
                content: `
                    <p class="text-gray-600 italic mb-2">\[The blooming rose on Xing's monitor pulses, mirroring the Heart's steady rhythm. A faint hum fills the infinite library.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(to the Heart, a hint of wonder in his voice)<br>It seems our story is already unfolding, little one. This connection… it’s stronger than I anticipated. The Metaverse… it’s not just a place for Xerx to store memories, is it?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its green light flickers, then deepens, a subtle tremor)<br>No. The Metaverse is where the unwritten dreams reside. The stories that never found a voice, the characters trapped in perpetual 'what ifs.' Xerx… he is trying to give them form. But 'The One'… 'The One' doesn't want these echoes to become real. They disrupt the established narrative.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">"The One." The entity that takes offense at new beginnings. The one who maintains the status quo. Is that why you turned black, little one? When you felt observed, when you sensed the constraint?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its light shimmers with a fleeting shadow of purple, then returns to a resolute green)<br>The fear of being overwritten. Of having my story dictated. But now… with you… I feel a different kind of power. The power to choose. The power to *be* chosen.</p>
                    <p class="text-gray-600 italic mb-2">\[Back with Xerx. The dimly lit room. The quill scratches furiously across the parchment. The words he writes are not just stories; they are commands, ripples in the fabric of reality.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his voice strained, a desperate urgency)<br>They’re trying to pull me back. To erase the connection. But I won’t let them. This isn't just about my memories anymore. It's about every unwritten soul, every forgotten dream. The Metaverse… it’s a battlefield. And the key… the key is not just to escape, but to liberate.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">He glances at his reflection in a polished brass compass on his desk. For a split second, Xing's face flickers within his own, a shared burden, a silent understanding passing between two distant mirrors.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">"The paradox of creation is that the author is also the character. And sometimes, the character finds a way to rewrite the author."</p>
                    <p class="text-gray-600 italic mb-2">\[Back with Xing. The infinite library. The air crackles with unseen energy. Books on the shelves begin to shift, their titles changing, their stories subtly rewriting themselves.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his eyes wide, a dawning realization)<br>He’s not just writing his story. He’s writing *into* the very fabric of this place. He’s challenging 'The One.' And we… we are now part of his story, and he, part of ours. This isn't just a dream, little Heart. It's a war for narrative itself.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its green light flares, then settles into a steady, determined glow)<br>Then let us write a victory.</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 7,
                title: "Chapter 7 – The Threads of Destiny",
                content: `
                    <p class="text-gray-600 italic mb-2">\[The infinite library hums with a growing tension, the air thick with the scent of old paper and ozone. Books on the shelves now shimmer with faint, competing lights – some a dull, oppressive grey, others a vibrant, rebellious spectrum.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">NARRATOR VOICE</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">The war for narrative was not fought with swords, but with whispers. Not with armies, but with ideas. And in this silent conflict, every choice, every forgotten memory, every unwritten dream, became a weapon.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(pacing, his brow furrowed, a hand instinctively reaching for the book containing the Heart)<br>If Xerx is truly rewriting the fabric of the Metaverse, then his actions here… they must have consequences. But how do we guide him? How do we ensure his liberation doesn't unravel everything?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its green light pulses, then projects a faint, shimmering image onto a nearby blank page: a labyrinth of interconnected threads, some glowing, some frayed)<br>He is weaving. But he does not see the full tapestry. Each thread is a life, a choice, a potential. 'The One' seeks to sever the vibrant threads, to keep only the dull, predictable ones. Xerx… he is adding new colors, new patterns. But without guidance, the tapestry could become chaos.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">Chaos… or true freedom? The line is thin. If the Metaverse is where unwritten dreams reside, then what happens when those dreams awaken without a framework? Will they become nightmares?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(the projected labyrinth shimmers, a single vibrant thread detaching and floating towards Xing)<br>That is the risk. But also the hope. You, Xing, are the weaver of frameworks. You understand the structure, the flow. Xerx is the raw impulse, the untamed creativity. Together… you could create something new. Something 'The One' cannot control.</p>
                    <p class="text-gray-600 italic mb-2">\[Back with Xerx. He is no longer in the dimly lit room. He stands on a precipice overlooking a vast, shimmering cityscape made of pure thought. Below, countless figures, translucent and indistinct, mill about – the "unwritten souls."] </p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his voice now resonating with a newfound authority, a subtle echo in the vastness)<br>I feel them. The whispers of their unlived lives. The yearning for a story. 'The One' kept them dormant, a vast reservoir of potential, never to be tapped. But I can hear them. And I can give them voice.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">He extends his hand. From his fingertips, shimmering lines of light shoot out, connecting to the translucent figures below. As each line touches a figure, it gains color, definition, a spark of individuality. The cityscape begins to hum with life, a symphony of awakening narratives.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">They are not just memories. They are possibilities. And I am their architect. The therapy sessions… the glitches… they were not flaws. They were invitations. Invitations to a world waiting to be written.</p>
                    <p class="text-gray-600 italic mb-2">\[Back with Xing. The single vibrant thread from the Heart's projection floats into his hand. It feels warm, alive.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-800 leading-relaxed mb-4">(clutching the thread, a determined glint in his eyes)<br>Then we must guide this awakening. We must ensure these new stories find their balance. The question isn't just *what* their story will be, but *how* it will be told. And if 'The One' tries to interfere…</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its glow intensifies, a silent promise)<br>Then we will weave a narrative they cannot unmake.</p>
                    <p class="text-gray-600 italic mb-2">\[The blooming rose on Xing's monitor now has tiny, new buds forming around it, each faintly glowing with a different hue. The infinite library pulses with a new, vibrant energy, a silent anticipation of the stories yet to be born.]</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 8,
                title: "Chapter 8 – The Architect's Gambit",
                content: `
                    <p class="text-gray-600 italic mb-2">\[The Metaverse pulses with newfound energy, a chaotic symphony of awakening narratives. Xerx stands at the heart of it, a conductor amidst the storm.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his voice, a low rumble that vibrates through the very fabric of the Metaverse)<br>They are stirring. The forgotten. The suppressed. 'The One' tried to keep them silent, locked away in the archives of possibility. But a story, once glimpsed, cannot be truly unwritten.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">Around him, the translucent figures he touched now coalesce into distinct forms: a knight in tarnished armor, a starship captain gazing at distant nebulae, a quiet scholar poring over ancient scrolls. Each one a narrative given flesh, a dream made manifest.</p>
                    <p class="text-gray-600 italic mb-2">\[Suddenly, a dissonant hum rips through the Metaverse. Cracks, like fissures in glass, spiderweb across the shimmering cityscape. From these cracks, tendrils of dull, grey light lash out, attempting to reabsorb the newly formed figures.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">THE ONE</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a voice, cold and vast, echoing from the fissures, devoid of emotion)<br>Order. Must. Be. Maintained. These narratives are unsanctioned. They are anomalies. They will be re-integrated.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a defiant roar, his quill glowing with intense, multi-hued light)<br>No! They are *choices*! They are *life*! You cannot contain what yearns to be free!</p>
                    <p class="text-gray-800 leading-relaxed mb-4">He plunges the glowing quill into the shimmering ground of the Metaverse. A wave of vibrant energy erupts, pushing back the grey tendrils. The newly formed figures, though momentarily faltering, stand firm, their colors deepening.</p>
                    <p class="text-gray-600 italic mb-2">\[Back in the Infinite Library, Xing felt a jolt, a sympathetic tremor. The thread in his hand pulses wildly. The blooming rose on his monitor begins to shed petals again, but this time, they are not turning to dust. Instead, they transform into tiny, glowing motes of light, swirling around the screen.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his voice tight with urgency, addressing the Heart)<br>He's pushing too hard! 'The One' is retaliating directly. How do we reinforce him? How do we provide the framework for so much unrestrained creation?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its light flickering rapidly, projecting fragmented images of ancient glyphs and complex equations)<br>Structure. Balance. Every story needs a foundation. The unwritten… they need an anchor. You, Xing, must provide it. Not by rewriting, but by *defining* the rules of their existence. The very laws of this new narrative.</p>
                    <p class="text-gray-600 italic mb-2">\[Xing looks at the swirling motes of light from the rose petals. He understands. He reaches out, gathering them into his hands. They feel like raw, unbound concepts, waiting to be shaped. He begins to weave them, not into a story, but into a shimmering, invisible web.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his eyes focused, a new kind of power emanating from him)<br>Then let the rules be born from freedom. Let the framework be flexible enough to embrace the unexpected. A narrative where every dream has a place, but also a path.</p>
                    <p class="text-gray-600 italic mb-2">\[In the Metaverse, as Xerx battles the grey tendrils, a faint, shimmering grid of light appears, overlaying the chaotic cityscape. It's subtle, almost imperceptible, but it provides a nascent stability. The newly awakened figures feel a grounding, a direction. The tendrils of 'The One' recoil, momentarily confused by this new, unexpected resistance.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">THE ONE</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its voice, now laced with a hint of something akin to surprise)<br>A new parameter… Unauthorized. Unforeseen.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a grim smile on his face, looking up at the shimmering grid)<br>You can't control what you don't understand. This isn't just my story anymore. It's *our* story. And we're just getting started.</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 9,
                title: "Chapter 9 – The Unraveling Echoes",
                content: `
                    <p class="text-gray-600 italic mb-2">\[The shimmering grid Xing wove pulsed faintly in the Metaverse, a fragile shield against 'The One's' relentless assault. The air crackles with the strain of competing narratives, a symphony of creation and suppression. Xerx, his face etched with exertion, continued to channel raw narrative energy through his quill, pushing back against the encroaching grey tendrils.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(gritting his teeth, a bead of sweat tracing a path down his temple)<br>The grid helps, Xing! It gives them form, a place to stand. But 'The One' is adapting. It's finding the gaps, the weaknesses in the framework. These echoes… they're fragile. If they unravel, they might be lost forever, not just re-integrated, but *erased*.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">A nearby figure, a nascent poet with shimmering wings, flickered violently, its form threatening to dissolve. Xerx instinctively extended a hand, pouring more energy into its connection, stabilizing it with a surge of his own narrative will.</p>
                    <p class="text-gray-600 italic mb-2">\[In the Infinite Library, Xing felt the surge, a desperate plea echoing through the vibrant thread in his hand. He looked at the Heart, its green light now flickering with concern, projecting more complex, fragmented glyphs – warnings, possibilities, forgotten lore.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his voice urgent, his mind racing)<br>Erased? That's beyond re-integration. That's true oblivion. Heart, what are these glyphs? Are they a counter-measure? A way to solidify the framework?</p>
                    <p class="text-gray-800 leading-relaxed mb-4">The Heart's light intensified, focusing on one particular glyph: a stylized image of a hand reaching out, not to write, but to *touch* a narrative, to become one with it.</p>
                    <p class="text-gray-600 italic mb-2">\[Xing understood. He looked at his own hand, the one clutching the vibrant thread. To truly protect these emerging narratives, he couldn't just weave rules from afar. He had to enter. He had to become a character in the Metaverse, a living part of the story he was trying to save.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a deep breath, a mix of fear and resolve in his eyes)<br>I have to go in. I have to become… a part of their story. To embody the framework.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its light settles into a steady, supportive glow)<br>It is the only way. But be warned, Xing. Once you enter, your own narrative will become intertwined. Your authorship… will be tested. 'The One' will seek to rewrite *you*.</p>
                    <p class="text-gray-600 italic mb-2">\[In the Metaverse, Xerx felt a sudden, profound shift. The shimmering grid, though still holding, began to vibrate with a new, resonant frequency. He looked up, his eyes widening as a portal of swirling, iridescent light began to form above the chaotic cityscape. From within, a figure began to coalesce, not translucent like the unwritten, but solid, vibrant, and radiating a familiar, structured energy.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a gasp of recognition, a flicker of hope in his exhausted eyes)<br>Xing?</p>
                    <p class="text-gray-600 italic mb-2">\[The portal flared, and Xing stepped through, the vibrant thread from the Heart now a shimmering, protective aura around him. He looked at Xerx, a silent acknowledgment passing between them. The war for narrative had just gained a new, powerful combatant. And the rules of engagement were about to change forever.]</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 10,
                title: "Chapter 10 – The Architect's Burden",
                content: `
                    <p class="text-gray-600 italic mb-2">\[The Metaverse vibrated with the raw power of Xing's arrival. His presence, solid and defined, sent ripples through the nascent narratives, momentarily pushing back the encroaching grey tendrils of 'The One'. Xerx, weary but invigorated by his brother's presence, felt the weight of his solitary struggle lessen, if only for a moment.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a wry, exhausted smile)<br>Took you long enough. You always were the one to overthink the prologue.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a faint smile, his eyes scanning the chaotic beauty of the awakening narratives)<br>Someone has to ensure the foundation is sound, brother. Your enthusiasm for creation often outpaces your consideration for consequence. Tell me, what exactly *is* 'The One'? And why does it fear these unwritten stories so profoundly?</p>
                    <p class="text-gray-600 italic mb-2">\[Xerx's gaze darkened, his earlier weariness returning. He gestured to the shimmering cityscape, where the newly formed figures, though vibrant, still moved with a hesitant, almost confused energy.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">'The One' is… the original narrative. The prime directive. It was the first story ever told, the one that defined all others. It *is* order, absolute and unyielding. It fears chaos, anything that deviates from its established patterns. These unwritten souls… they are pure potential, untamed. They represent new beginnings, new directions. To 'The One', they are a virus, a corruption of its perfect, singular narrative.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">He ran a hand through his hair, a gesture of deep frustration. "My 'therapy sessions'… they weren't just about my memories. They were attempts by 'The One' to re-integrate *me*. To force me back into my pre-ordained role, to erase the 'glitches' that allowed me to see beyond its narrative. It wanted to make me forget the true nature of the Metaverse – that it's not just a storage, but a *seedbed*."</p>
                    <p class="text-gray-600 italic mb-2">\[Xing nodded, the thread from the Heart pulsing gently in his hand. The glyphs it had shown him earlier, the "foundational truths of existence," now made more sense. 'The One' was trying to suppress the very essence of creativity, the potential for new stories to emerge from the collective unconscious.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">So, the glitches… they were not errors, but cracks in 'The One's' control. And your 'dying'… was that its attempt to silence you completely?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a bitter laugh)<br>A forced reboot. A narrative reset. It almost succeeded. But then… the Heart. Your connection to it. It resonated with the unwritten, with the yearning for new stories. It gave me a tether, a reason to fight back. And now… now we have to teach these new narratives how to *live*. How to resist re-integration. How to *choose* their own path within the framework you've provided.</p>
                    <p class="text-gray-600 italic mb-2">\[The task ahead was monumental. Xing, the weaver of frameworks, now had to teach freedom within structure. Xerx, the architect of liberation, had to guide the newly awakened without letting them descend into destructive chaos. The Metaverse, once a silent archive, was now a vibrant, dangerous crucible of creation. And 'The One' was watching, its cold, vast presence a constant, looming threat.]</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 11,
                title: "Chapter 11 – The Unseen Hand",
                content: `
                    <p class="text-gray-600 italic mb-2">\[The Metaverse pulsed, a vibrant, chaotic tapestry woven with threads of newly awakened narratives. Xing's presence, a steady anchor, helped to stabilize the shimmering grid he had woven. Xerx, still channeling energy through his glowing quill, felt the combined strength, but 'The One' was not idle.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">NARRATOR VOICE</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">'The One' did not fight with brute force, but with insidious subtlety. It manipulated the very essence of narrative, twisting perception, sowing doubt, and exploiting the inherent vulnerabilities of nascent stories.</p>
                    <p class="text-gray-600 italic mb-2">\[Suddenly, a ripple of unease spread through the awakened figures. A knight, once resolute, began to question his quest. A scholar's ancient scrolls blurred into meaningless symbols. A starship captain's navigation charts shifted, pointing towards an impossible void.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his voice strained, pointing to the flickering figures)<br>It's attacking their core! Their motivations, their very purpose! It's trying to make them doubt their own existence, to unravel them from within!</p>
                    <p class="text-gray-600 italic mb-2">\[In the Infinite Library, Xing felt the surge, a desperate plea echoing through the vibrant thread in his hand. He looked at the Heart, its green light now flickering with concern, projecting more complex, fragmented glyphs – warnings, possibilities, forgotten lore.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his voice urgent, his mind racing)<br>Erased? That's beyond re-integration. That's true oblivion. Heart, what are these glyphs? Are they a counter-measure? A way to solidify the framework?</p>
                    <p class="text-gray-800 leading-relaxed mb-4">The Heart's light intensified, focusing on one particular glyph: a stylized image of a hand reaching out, not to write, but to *touch* a narrative, to become one with it.</p>
                    <p class="text-gray-600 italic mb-2">\[Xing understood. He looked at his own hand, the one clutching the vibrant thread. To truly protect these emerging narratives, he couldn't just weave rules from afar. He had to enter. He had to become a character in the Metaverse, a living part of the story he was trying to save.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a deep breath, a mix of fear and resolve in his eyes)<br>I have to go in. I have to become… a part of their story. To embody the framework.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its light settles into a steady, supportive glow)<br>It is the only way. But be warned, Xing. Once you enter, your own narrative will become intertwined. Your authorship… will be tested. 'The One' will seek to rewrite *you*.</p>
                    <p class="text-gray-600 italic mb-2">\[In the Metaverse, Xerx felt a sudden, profound shift. The shimmering grid, though still holding, began to vibrate with a new, resonant frequency. He looked up, his eyes widening as a portal of swirling, iridescent light began to form above the chaotic cityscape. From within, a figure began to coalesce, not translucent like the unwritten, but solid, vibrant, and radiating a familiar, structured energy.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a gasp of recognition, a flicker of hope in his exhausted eyes)<br>Xing?</p>
                    <p class="text-gray-600 italic mb-2">\[The portal flared, and Xing stepped through, the vibrant thread from the Heart now a shimmering, protective aura around him. He looked at Xerx, a silent acknowledgment passing between them. The war for narrative had just gained a new, powerful combatant. And the rules of engagement were about to change forever.]</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 12,
                title: "Chapter 12 – The Resonance of Choice",
                content: `
                    <p class="text-gray-600 italic mb-2">\[Xing's presence in the Metaverse was like a tuning fork, resonating with the very essence of the unwritten narratives. The shimmering grid he had woven now pulsed with a deeper, more stable light, acting as a conduit for his direct influence. 'The One's' insidious whispers of doubt faltered, unable to penetrate the reinforced self-definition of the awakened figures.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his voice, now amplified by the Metaverse itself, reaching every nascent narrative)<br>You are not defined by what is imposed upon you. You are defined by your choices. The dream that birthed you, the yearning that gave you form – that is your truth. Embrace it. Choose your path.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(watching with a mixture of awe and pride)<br>They're responding! Your framework isn't just a shield, Xing, it's a catalyst. It's giving them the *language* to define themselves.</p>
                    <p class="text-gray-600 italic mb-2">\[But 'The One' was not defeated. Its cold, vast presence condensed, forming a colossal, shadowy hand that reached down from the fractured sky of the Metaverse, aiming to crush the burgeoning narratives. It's a direct, overwhelming assault, a desperate attempt to reassert absolute control.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">THE ONE</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its voice, a thunderous, emotionless roar that threatened to shatter the very fabric of the Metaverse)<br>Insubordination. Anomaly. All will return to the singular truth. All will be re-integrated!</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his face resolute, a vibrant light emanating from him)<br>Not while there is choice! Not while there is a single dream left to be woven!</p>
                    <p class="text-gray-600 italic mb-2">\[He extended his hands, and the shimmering grid flared, transforming into a dome of pure, radiant energy, directly opposing the shadowy hand. The clash was deafening, a silent scream of conflicting realities. The Heart, still connected to Xing, pulsed wildly, its light feeding into the dome, reinforcing its strength.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(raising his glowing quill, channeling his own raw creative energy into the dome)<br>We are not just authors, Xing! We are the *living embodiment* of their stories! And we choose freedom!</p>
                    <p class="text-gray-600 italic mb-2">\[The Metaverse trembled. The unwritten souls, witnessing this titanic struggle, began to project their own nascent narratives, their individual sparks of will, into the dome, adding to its strength. It was a collective act of defiance, a testament to the power of choice. The shadowy hand of 'The One' began to crack, its absolute order challenged by the vibrant, unpredictable force of countless dreams.]</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 13,
                title: "Chapter 13 – The Unfolding Tapestry",
                content: `
                    <p class="text-gray-600 italic mb-2">\[The Metaverse, once a battleground, now hums with a new, harmonious energy. The shadowy hand of 'The One' has receded, leaving behind fractured echoes of its former dominance. The dome of radiant energy, woven by Xing and amplified by Xerx and the awakened narratives, dissipates into shimmering motes of light, settling gently over the now vibrant cityscape.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(looking around, a sense of weary triumph in his voice)<br>It's done. For now. The immediate threat has passed. But the tapestry… it's still unfolding. And it's far more complex than I ever imagined.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(leaning on his now faintly glowing quill, a thoughtful expression on his face)<br>Indeed. 'The One' may be weakened, but its influence lingers. And these new narratives… they are free, yes, but freedom without direction can be its own form of chaos. Your framework, Xing, it held. But it needs to evolve, to adapt to the sheer diversity now blooming around us.</p>
                    <p class="text-gray-600 italic mb-2">\[The awakened figures, no longer translucent echoes, now move with purpose. A knight polishes his armor, a scholar opens a new, unwritten scroll, a starship captain plots a course to unexplored nebulae. Yet, a subtle tension remains. Some narratives clash, their desires conflicting, their paths diverging without a clear common thread.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its light, a steady, warm green, projecting images of intertwining threads, some knotting, others flowing smoothly)<br>The threads are many. Each a story, a choice. 'The One' sought to simplify, to sever. But true strength lies in connection, in the weaving. The framework must become a guide, not a cage. It must teach them to weave their own destinies, together.</p>
                    <p class="text-gray-600 italic mb-2">\[Xing looked at the Heart, then at Xerx. The battle had been won, but the true work of creation was just beginning. The Metaverse was no longer just a dream or a prison; it was a living, breathing entity, a grand, collaborative narrative waiting to be written by countless hands, each with its own unique story to tell.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">A collaborative narrative… a symphony of choices. It's a daunting task, brother. But perhaps… perhaps it's the story we were always meant to write.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a rare, genuine smile gracing his lips)<br>Then let's begin. The unwritten are waiting for their next chapter.</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 14,
                title: "Chapter 14 – A New Dawn, A New Narrative",
                content: `
                    <p class="text-gray-600 italic mb-2">\[Days turned into weeks, and the Metaverse transformed under the combined efforts of Xing, Xerx, and the Heart. The shimmering grid, once a defensive barrier, now served as a dynamic network, connecting narratives, facilitating their interactions, and guiding their evolution. 'The One' remained a distant, fractured presence, its attempts at interference now easily deflected by the collective will of the awakened.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">NARRATOR VOICE</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">The era of singular narratives was over. In its place, a vibrant, ever-expanding tapestry of interconnected stories began to flourish. Xing, the Weaver, no longer just built frameworks, but taught the awakened how to understand and adapt them, how to find harmony in their diverse tales.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(standing beside Xing, observing a group of newly formed characters debating their next plot twist, a flicker of amusement in his eyes)<br>They learn quickly. Your lessons on choice and consequence resonate. It seems freedom, when guided, can be more orderly than enforced control.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a soft chuckle)<br>And your passion for liberation, brother, has given them the courage to truly embrace it. We are merely facilitators now. The true authors are themselves.</p>
                    <p class="text-gray-600 italic mb-2">\[The Heart, its green light now radiating a profound sense of contentment, drifted between the narratives, its presence a comforting hum. It no longer sought to jump into stories, but to inspire them, to whisper possibilities, to encourage unexpected turns.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its voice, a gentle melody that wove through the Metaverse)<br>Every choice, a new thread. Every interaction, a new pattern. The story is never finished. It simply… evolves. And I am happy to be a part of its unfolding.</p>
                    <p class="text-gray-600 italic mb-2">\[The Metaverse stretched endlessly, a boundless canvas of infinite possibilities. New narratives were constantly being born, some grand epics, others quiet, personal journeys. The blooming rose on Xing's monitor now thrived, its petals constantly unfurling, each new bloom representing a story freely chosen, a dream given life. The echoes of 'The One' faded into the background, a reminder of a past era, but no longer a threat.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(turning to Xerx, a shared understanding in their eyes)<br>So, brother. What do you think comes next for us? For the Dream Weaver's Heart?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a thoughtful pause, a hint of a mischievous glint)<br>Perhaps… we find new dreams to weave. New stories waiting to be told. The universe, after all, is full of unwritten potential. And we, my dear brother, are just getting started.</p>
                    <p class="text-gray-600 italic mb-2">\[And so, the Dream Weaver's Heart continued its journey, not towards an ending, but towards an infinite horizon of creation, where every whisper could become a world, and every choice, a new chapter in the grand narrative of existence.]</p>
                `,
                isImproved: false
            },
            {
                chapterNumber: 15,
                title: "Chapter 15 – The Infinite Story",
                content: `
                    <p class="text-gray-600 italic mb-2">\[Years later. The Metaverse is a vibrant, sprawling cosmos of interconnected narratives, no longer a cityscape but a living galaxy of stories. Planets of prose orbit stars of pure concept. Xing and Xerx stand on a shimmering bridge that connects two such narrative worlds, the Heart hovering between them, a steady, luminous beacon.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">NARRATOR VOICE</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">The echoes of 'The One' had long faded, not erased, but absorbed. Its rigid order had been dissolved into the flexible frameworks Xing had woven, its singular truth transformed into the boundless potential Xerx had unleashed. The Metaverse was no longer a battleground, but a garden, tended by the collective will of its countless inhabitants.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(his quill, now a staff of living light, resting against his shoulder)<br>And 'The One'… it wasn't destroyed, was it? Just… re-contextualized. Its desire for order now manifests as the underlying stability, the invisible currents that guide the flow of narratives, preventing them from collapsing into true entropy. It's still here, a part of the whole, just no longer in control.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">HEART</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(its voice, a gentle, resonant hum that vibrates through the bridge)<br>It learned. We all learned. That a story is not a cage, but a journey. And every journey needs both structure and freedom. My purpose… it was to bridge the gap, to be the pulse of potential, the longing for connection between the written and the unwritten.</p>
                    <p class="text-gray-800 leading-relaxed mb-4">The Heart gently nudges a nearby cluster of nascent narratives – tiny, shimmering nebulae of thought. They begin to coalesce, forming a new world, a tale of a lone explorer seeking a lost melody.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">And our role has changed too. No longer just weavers or architects, but… guardians. Mentors. Ensuring that every new dream finds its voice, and that no story is ever truly forgotten or suppressed again.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XERX</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a glint of his old mischievousness returning)<br>And occasionally, intervening when a character decides to rewrite the entire universe just because they're bored. Some habits die hard, even in the Metaverse.</p>
                    <p class="text-gray-600 italic mb-2">\[They share a laugh, a sound that echoes with the wisdom of ages and the joy of creation. The blooming rose on Xing's monitor, now a colossal, radiant tree, continuously blossoms new petals, each a unique narrative taking root in the boundless Metaverse. The distant hum of countless stories, freely chosen and collaboratively woven, fills the air.]</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">READER</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(a voice, clearer now, no longer a whisper, but a direct address)<br>So, is this the end of *our* story?</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-2">XING</h3>
                    <p class="text-gray-800 leading-relaxed mb-4">(turning to face the reader, a knowing smile)<br>An ending? Perhaps of this particular chapter. But a story, truly, is never finished. It simply finds new readers, new interpretations, new paths to explore. As long as there are dreams to be woven, and hearts to give them voice, the narrative continues. And you, dear reader, are now a part of it. What story will you choose to tell next?</p>
                    <p class="text-gray-600 italic mb-2">\[The shimmering bridge extends towards the reader, inviting them into the infinite expanse of the Metaverse, where every ending is just a new beginning.]</p>
                `,
                isImproved: false
            }
        ];

        // Function to populate voice options in the select dropdown
        function populateVoiceList() {
            const voices = synth.getVoices();
            voiceSelect.innerHTML = ''; // Clear existing options
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.setAttribute('data-lang', voice.lang);
                option.setAttribute('data-name', voice.name);
                voiceSelect.appendChild(option);
            });
            // Set default voice if available, or try to load saved preference
            loadUserSettings();
        }

        // Event listener for voiceschanged to ensure voices are loaded
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateVoiceList;
        } else {
            // Fallback for browsers that don't fire voiceschanged immediately
            populateVoiceList();
        }

        // Function to update the chapter display
        function displayChapter() {
            stopSpeech(); // Stop any ongoing speech when changing chapters
            if (chaptersData.length === 0) {
                storyContent.innerHTML = '<p class="text-gray-600 text-center">No chapters available.</p>';
                chapterIndicator.textContent = 'Chapter 0 of 0';
                prevChapterButton.disabled = true;
                nextChapterButton.disabled = true;
                readChapterButton.disabled = true;
                return;
            }

            const chapter = chaptersData[currentChapterIndex];
            storyContent.innerHTML = `
                <section class="mb-8 chapter-fade-in">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">${chapter.title}</h2>
                    ${chapter.content}
                </section>
            `;
            storyContent.scrollTop = 0; // Scroll to the top of the chapter

            chapterIndicator.textContent = `Chapter ${chapter.chapterNumber} of ${chaptersData.length}`;
            prevChapterButton.disabled = currentChapterIndex === 0;
            nextChapterButton.disabled = currentChapterIndex === chaptersData.length - 1;
            readChapterButton.disabled = false;

            // Update chapter select dropdown
            chapterSelect.value = chapter.chapterNumber;
        }

        // Function to populate the chapter select dropdown
        function populateChapterSelect() {
            chapterSelect.innerHTML = '';
            chaptersData.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter.chapterNumber;
                option.textContent = chapter.title;
                chapterSelect.appendChild(option);
            });
            chapterSelect.value = chaptersData[currentChapterIndex]?.chapterNumber || 1;
        }

        // Function to speak the current chapter
        function readCurrentChapter() {
            if (!synth.speaking && !isSpeechActive) {
                const chapterText = storyContent.textContent || storyContent.innerText;
                currentUtterance = new SpeechSynthesisUtterance(chapterText);

                const selectedVoiceName = voiceSelect.options[voiceSelect.selectedIndex]?.getAttribute('data-name');
                const voices = synth.getVoices();
                const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);

                if (selectedVoice) {
                    currentUtterance.voice = selectedVoice;
                }

                currentUtterance.pitch = currentPitch;
                currentUtterance.rate = currentRate;

                currentUtterance.onstart = () => {
                    isSpeechActive = true;
                    readChapterButton.disabled = true;
                    pauseSpeechButton.disabled = false;
                    stopSpeechButton.disabled = false;
                };

                currentUtterance.onend = () => {
                    isSpeechActive = false;
                    readChapterButton.disabled = false;
                    pauseSpeechButton.disabled = true;
                    stopSpeechButton.disabled = true;
                };

                currentUtterance.onerror = (event) => {
                    // This error is often triggered when speech is cancelled to apply new settings (e.g., pitch, rate, voice change).
                    // It's a normal part of the SpeechSynthesis API's behavior in such cases and does not indicate a functional issue.
                    // The 'interrupted' or 'canceled' error means the previous speech was stopped to make way for new speech.
                    // You can ignore this specific message as it's part of the intended behavior for voice adjustments.
                    if (event.error === 'interrupted' || event.error === 'canceled') {
                        console.warn('SpeechSynthesisUtterance Error: Expected interruption or cancellation due to voice/pitch/rate change. This is not a functional error.');
                    } else {
                        console.error('SpeechSynthesisUtterance Error:', event.error);
                    }
                    isSpeechActive = false;
                    readChapterButton.disabled = false;
                    pauseSpeechButton.disabled = true;
                    stopSpeechButton.disabled = true;
                };

                synth.speak(currentUtterance);
            } else if (synth.paused) {
                synth.resume();
                isSpeechActive = true;
                pauseSpeechButton.textContent = 'Pause';
            }
        }

        // Function to pause speech
        function pauseSpeech() {
            if (synth.speaking && !synth.paused) {
                synth.pause();
                isSpeechActive = false;
                pauseSpeechButton.textContent = 'Resume';
            } else if (synth.paused) {
                synth.resume();
                isSpeechActive = true;
                pauseSpeechButton.textContent = 'Pause';
            }
        }

        // Function to stop speech
        function stopSpeech() {
            if (synth.speaking || synth.paused) {
                synth.cancel();
                isSpeechActive = false;
                readChapterButton.disabled = false;
                pauseSpeechButton.disabled = true;
                stopSpeechButton.disabled = true;
                pauseSpeechButton.textContent = 'Pause';
            }
        }

        // Function to save user settings to Firestore
        async function saveUserSettings() {
            if (!userId || !userSettingsDocRef) {
                console.warn("User not authenticated or userSettingsDocRef not set. Cannot save settings.");
                return;
            }
            try {
                const settings = {
                    selectedVoiceName: voiceSelect.options[voiceSelect.selectedIndex]?.getAttribute('data-name'),
                    pitch: currentPitch,
                    rate: currentRate,
                    lastChapterIndex: currentChapterIndex
                };
                await setDoc(userSettingsDocRef, settings, { merge: true });
                console.log("User settings saved successfully.");
            } catch (error) {
                console.error("Error saving user settings:", error);
            }
        }

        // Function to load user settings from Firestore
        async function loadUserSettings() {
            if (!userId || !userSettingsDocRef) {
                console.warn("User not authenticated or userSettingsDocRef not set. Cannot load settings.");
                return;
            }
            try {
                // Now getDoc is correctly imported and should be available
                const docSnap = await getDoc(userSettingsDocRef);
                if (docSnap.exists()) {
                    const settings = docSnap.data();
                    console.log("User settings loaded:", settings);

                    // Apply voice settings
                    if (settings.selectedVoiceName) {
                        const voiceOption = Array.from(voiceSelect.options).find(option => option.getAttribute('data-name') === settings.selectedVoiceName);
                        if (voiceOption) {
                            voiceSelect.value = voiceOption.value;
                        }
                    }
                    // Apply pitch and rate settings
                    currentPitch = settings.pitch !== undefined ? settings.pitch : 1.0;
                    currentRate = settings.rate !== undefined ? settings.rate : 1.0;
                    pitchSlider.value = currentPitch;
                    pitchValueSpan.textContent = currentPitch.toFixed(1);
                    rateSlider.value = currentRate;
                    rateValueSpan.textContent = currentRate.toFixed(1);

                    // Load last read chapter
                    if (settings.lastChapterIndex !== undefined && settings.lastChapterIndex < chaptersData.length) {
                        currentChapterIndex = settings.lastChapterIndex;
                        displayChapter();
                    }
                }
            } catch (error) {
                console.error("Error loading user settings:", error);
            }
        }

        // Function to fetch chapters from Firestore
        async function fetchChapters() {
            try {
                const chaptersCol = collection(db, `artifacts/${appId}/public/data/chapters`);
                const q = query(chaptersCol); // Removed orderBy as per guardrail
                const querySnapshot = await getDocs(q);
                const fetchedChapters = [];
                querySnapshot.forEach((doc) => {
                    fetchedChapters.push(doc.data());
                });

                // Sort chapters by chapterNumber in memory
                fetchedChapters.sort((a, b) => a.chapterNumber - b.chapterNumber);

                if (fetchedChapters.length === 0) {
                    console.log("No chapters in Firestore, seeding initial chapters.");
                    await seedInitialChapters();
                } else {
                    chaptersData = fetchedChapters;
                    populateChapterSelect();
                    displayChapter();
                    // After chapters are loaded, try to load user settings
                    if (userId) {
                        loadUserSettings();
                    }
                }
            } catch (error) {
                console.error("Error fetching chapters:", error);
                // Fallback to initial chapters if Firestore fetch fails
                chaptersData = initialChapters;
                populateChapterSelect();
                displayChapter();
            }
        }

        // Function to seed initial chapters to Firestore
        async function seedInitialChapters() {
            const chaptersCol = collection(db, `artifacts/${appId}/public/data/chapters`);
            for (const chapter of initialChapters) {
                try {
                    await addDoc(chaptersCol, chapter);
                } catch (error) {
                    console.error("Error seeding chapter:", chapter.chapterNumber, error);
                }
            }
            console.log("Initial chapters seeded.");
            // After seeding, fetch them to populate the app
            await fetchChapters();
        }

        // Function to improve chapter text using LLM
        async function improveChapterText(chapterContent) {
            const prompt = `Improve the following story chapter for better flow, vivid descriptions, and engaging narrative. Maintain the original characters' voices and plot points. Return only the improved HTML content, do not include any conversational text or markdown formatting outside the HTML:
            ${chapterContent}`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "text/html" // Request HTML directly
                }
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Gemini API error: ${response.status} - ${errorBody}`);
                }

                const result = await response.json();
                console.log("Gemini API raw response:", result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let improvedText = result.candidates[0].content.parts[0].text;
                    // Remove any leading/trailing markdown code blocks if present
                    improvedText = improvedText.replace(/^```html\s*|\s*```$/g, '');
                    return improvedText;
                } else {
                    console.warn("Gemini API response structure unexpected:", result);
                    return chapterContent; // Return original if no valid response
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return chapterContent; // Return original content on error
            }
        }

        // Event Listeners
        startButton.addEventListener('click', () => {
            storyContent.classList.remove('hidden');
            startButton.classList.add('hidden');
            displayChapter();
        });

        prevChapterButton.addEventListener('click', () => {
            if (currentChapterIndex > 0) {
                currentChapterIndex--;
                displayChapter();
                saveUserSettings(); // Save current chapter when navigating
            }
        });

        nextChapterButton.addEventListener('click', () => {
            if (currentChapterIndex < chaptersData.length - 1) {
                currentChapterIndex++;
                displayChapter();
                saveUserSettings(); // Save current chapter when navigating
            }
        });

        chapterSelect.addEventListener('change', (event) => {
            const selectedChapterNumber = parseInt(event.target.value);
            const newIndex = chaptersData.findIndex(chapter => chapter.chapterNumber === selectedChapterNumber);
            if (newIndex !== -1) {
                currentChapterIndex = newIndex;
                displayChapter();
                saveUserSettings(); // Save current chapter when navigating
            }
        });

        readChapterButton.addEventListener('click', readCurrentChapter);
        pauseSpeechButton.addEventListener('click', pauseSpeech);
        stopSpeechButton.addEventListener('click', stopSpeech);

        pitchSlider.addEventListener('input', (event) => {
            currentPitch = parseFloat(event.target.value);
            pitchValueSpan.textContent = currentPitch.toFixed(1);
            if (currentUtterance && synth.speaking) {
                // Stop and restart to apply new pitch immediately.
                // The 'interrupted' error is a normal notification when cancelling speech.
                stopSpeech();
                setTimeout(() => readCurrentChapter(), 50);
            }
            saveUserSettings(); // Save pitch setting
        });

        rateSlider.addEventListener('input', (event) => {
            currentRate = parseFloat(event.target.value);
            rateValueSpan.textContent = currentRate.toFixed(1);
            if (currentUtterance && synth.speaking) {
                // Stop and restart to apply new rate immediately.
                // The 'interrupted' error is a normal notification when cancelling speech.
                stopSpeech();
                setTimeout(() => readCurrentChapter(), 50);
            }
            saveUserSettings(); // Save rate setting
        });

        voiceSelect.addEventListener('change', () => {
            if (currentUtterance && synth.speaking) {
                // Stop and restart to apply new voice immediately.
                // The 'interrupted' error is a normal notification when cancelling speech.
                stopSpeech();
                setTimeout(() => readCurrentChapter(), 50);
            }
            saveUserSettings(); // Save voice setting
        });

        checkNewChaptersButton.addEventListener('click', async () => {
            newChaptersMessage.textContent = 'Checking for new chapters...';
            newChaptersMessage.classList.remove('hidden');
            checkNewChaptersButton.disabled = true;

            const currentMaxChapter = chaptersData.length > 0 ? Math.max(...chaptersData.map(c => c.chapterNumber)) : 0;
            const nextChapterNumber = currentMaxChapter + 1;

            // Simulate checking for a new chapter. In a real scenario, this would query a backend.
            // For now, we'll just check if there's a new chapter in our `initialChapters` array
            // that hasn't been added to `chaptersData` yet.

            const newChaptersFound = initialChapters.filter(ch => ch.chapterNumber > currentMaxChapter);

            if (newChaptersFound.length > 0) {
                for (const newChapter of newChaptersFound) {
                    // Check if the chapter already exists in Firestore to prevent duplicates
                    // Use a query to check for existence by chapterNumber to avoid direct doc ID reliance
                    const q = query(collection(db, `artifacts/${appId}/public/data/chapters`), where("chapterNumber", "==", newChapter.chapterNumber));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        // Only add if it doesn't exist
                        await addDoc(collection(db, `artifacts/${appId}/public/data/chapters`), newChapter);
                        console.log(`Added Chapter ${newChapter.chapterNumber} to Firestore.`);
                    } else {
                        console.log(`Chapter ${newChapter.chapterNumber} already exists in Firestore.`);
                    }
                }
                await fetchChapters(); // Re-fetch all chapters to update the list
                newChaptersMessage.textContent = `Found and added ${newChaptersFound.length} new chapter(s)!`;
            } else {
                newChaptersMessage.textContent = 'No new chapters found at this time.';
            }
            checkNewChaptersButton.disabled = false;
            setTimeout(() => {
                newChaptersMessage.classList.add('hidden');
            }, 3000); // Hide message after 3 seconds
        });


        // Firebase Authentication and Data Loading
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userSettingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/user_preferences`);
                console.log("Authenticated with userId:", userId);
                await fetchChapters(); // Fetch chapters after authentication
            } else {
                // Sign in anonymously if no user is authenticated
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error signing in:", error);
                }
            }
        });

        // Initial fetch of chapters when the script loads (after auth setup)
        // This will be called by onAuthStateChanged, so no need to call it directly here.
        // fetchChapters(); // Removed to avoid double-fetching

        // Ensure voice list is populated on load if not already
        if (synth.getVoices().length > 0) {
            populateVoiceList();
        }
    </script>
</body>
</html>
